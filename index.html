<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Piau√≠GeoMap</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    :root {
      --gap: 10px;
      --shadow: 0 2px 6px rgba(0,0,0,0.25);
      --z-search: 3000;
      --z-layers: 2200;
      --z-north: 2100;
      --z-title: 2000;
      --z-legend: 1600;
      --z-coords: 1500;
    }

    * { font-family: Arial, sans-serif !important; box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      overflow: hidden;
    }

    #map {
      position: absolute; inset: 0;
      width: 100% !important; height: 100% !important;
    }

    /* T√≠tulo */
    .map-title {
      position: fixed;
      top: var(--gap);
      left: var(--gap);
      background: rgba(255,255,255,0.9);
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: bold;
      color: #333;
      box-shadow: var(--shadow);
      z-index: var(--z-title);
      max-width: 45vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Coordenadas (sem colidir com a legenda) */
    #coords {
      position: fixed;
      left: var(--gap);
      bottom: calc(100px + var(--gap));
      background: rgba(255, 255, 255, 0.8);
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 4px;
      border: 1px solid rgba(204, 204, 204, 0.6);
      z-index: var(--z-coords);
      box-shadow: var(--shadow);
    }

    /* Busca fixa (topo direito desktop, centralizada no mobile) */
    #searchContainer {
      position: fixed;
      top: var(--gap);
      right: var(--gap);
      display: flex;
      align-items: center;
      z-index: var(--z-search);
      width: 44px;           /* recolhido */
      height: 42px;
      overflow: hidden;      /* recolhido corta conte√∫do */
      background: white;
      border-radius: 40px;
      border: 1px solid #ccc;
      box-shadow: var(--shadow);
    }
    #searchToggle {
      background: none; border: none; cursor: pointer;
      font-size: 1.15rem; padding: 0 10px; height: 42px;
    }
    #searchMunicipio {
      flex: 1; border: none; outline: none;
      font-size: 1rem; padding: 0 10px; height: 42px;
      display: none; min-width: 0;
    }
    #searchContainer.expanded {
      width: 420px;
      overflow: visible;      /* permite a lista ‚Äúsair‚Äù do container */
    }
    #searchContainer.expanded #searchMunicipio { display: block; }

    /* Dropdown ancorado ao container da busca */
    #listaMunicipios {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      max-height: 280px;
      overflow-y: auto;
      background: white;
      border: 1px solid #ccc;
      border-top: none;
      border-radius: 0 0 12px 12px;
      box-shadow: var(--shadow);
      display: none;
      font-size: 14px;
      z-index: var(--z-search);
    }
    #listaMunicipios div {
      padding: 8px 10px; cursor: pointer; border-bottom: 1px solid #eee;
    }
    #listaMunicipios div:hover { background: #f2f2f2; }
    #listaMunicipios div.highlighted { background: #007bff; color: #fff; }

    /* Painel de camadas embrulhado (evita empurrar seta norte e t√≠tulo) */
    #camadasWrapper {
      position: fixed;
      top: 100px;             /* folga p/ t√≠tulo e busca */
      left: var(--gap);
      z-index: var(--z-layers);
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: var(--shadow);
      max-width: 320px;
    }
    #camadasHeader {
      background: #007bff; color: #fff; padding: 6px 12px;
      font-weight: bold; font-size: 14px; cursor: pointer; user-select: none;
    }
    .leaflet-control-layers {
      margin: 0 !important;
      padding: 6px !important;
      max-height: 50vh; overflow: auto;
      border: none !important;
      box-shadow: none !important;
    }
    .leaflet-control-layers.collapsed-panel { display: none !important; }

    /* Legenda fixa, centralizada no rodap√© */
    .legend {
      position: fixed;
      bottom:100px;
      left: 70%;
      transform: translateX(-50%);
      background: white;
      line-height: 18px;
      color: #333;
      padding: 12px;
      font-size: 14px;
      border-radius: 6px;
      max-width: min(92vw, 420px);
      max-height: 40vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
      z-index: var(--z-legend);
    }
    .legend-toggle {
      position: fixed;
      bottom: calc(var(--gap) + 48px);
      left: 70%;
      transform: translateX(-50%);
      display: block;
      background: #007bff; color: white;
      border: none; padding: 6px 14px;
      border-radius: 20px; font-size: 14px; cursor: pointer;
      z-index: var(--z-legend);
      box-shadow: var(--shadow);
    }
    .legend.collapsed {
      max-height: 0 !important;
      padding: 0 !important;
      overflow: hidden;
      opacity: 0;
    }

    /* Seta norte (topo direito) */
    .north-arrow {
      pointer-events: none;
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/7/7f/Map_symbol_north_arrow.svg/64px-Map_symbol_north_arrow.svg.png');
      background-size: contain; background-repeat: no-repeat;
      width: 40px; height: 40px; opacity: 0.85;
      margin: 0;
    }
    .leaflet-top.leaflet-right { top: 60px !important; right: var(--gap) !important; }

    /* Bot√£o de upload */
    #uploadBtn {
      position: fixed;
      top: 60px;
      right: var(--gap);
      background: white;
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      z-index: var(--z-search);
      box-shadow: var(--shadow);
    }
    
    #uploadInput { display: none; }

    /* Rosa dos ventos SBG */
    .rosa-sbg {
      position: fixed;
      left: var(--gap);
      bottom: var(--gap);
      width: 140px; height: 140px;
      transform: scale(0.6); transform-origin: bottom left;
      pointer-events: none;
      z-index: 1400;
    }

    /* Aten√ß√£o no bot√£o da legenda */
    .legend-toggle.attention { animation: pulseAttention 2.5s infinite ease-in-out; }
    @keyframes pulseAttention {
      0% { transform: translateX(-50%) scale(1); background-color: #007bff; }
      50% { transform: translateX(-50%) scale(1.06); background-color: #0056b3; }
      100% { transform: translateX(-50%) scale(1); background-color: #007bff; }
    }

    /* Mobile */
 @media (max-width: 768px) {
  /* mant√©m no topo-direito no mobile */
  #searchContainer {
    right: var(--gap);
    left: auto;
    transform: none;   /* <‚Äî remove o centrado */
    top: var(--gap);
    width: 44px;       /* recolhido */
  }
  #searchContainer.expanded {
    width: min(92vw, 420px); /* n√£o passa da tela */
  }


      #camadasWrapper {
        top: 100px;
        max-width: min(92vw, 520px);
      }
      .leaflet-control-layers { max-height: 38vh; }

      #coords {
        bottom: calc(1000px + var(--gap));
        font-size: 12px;
      }
      .rosa-sbg { width: 120px; height: 120px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="map-title">Piau√≠GeoMap</div>
  <div id="coords">Lat: -, Lon: -<br>E: -, N: -<br>Fuso: -</div>

  <button id="uploadBtn">Upload KML</button>
  <input type="file" id="uploadInput" accept=".kml,.kmz,.xml" multiple />

  <!-- Busca + lista acoplada -->
  <div id="searchContainer">
    <button id="searchToggle">üîç</button>
    <input type="text" id="searchMunicipio" placeholder="Pesquisar munic√≠pio" />
    <div id="listaMunicipios"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://unpkg.com/shp-write/shpwrite.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-ajax/dist/leaflet.ajax.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tokml@0.4.0/tokml.js"></script>
  <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>

  <script>
    const map = L.map('map').setView([-7, -42], 7.48);
    L.control.scale().addTo(map);

    // Move o zoom para baixo √† direita (n√£o colide com t√≠tulo/busca)
    map.zoomControl.remove();
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // Seta norte
    const north = L.control({position: "topright"});
    north.onAdd = function() { return L.DomUtil.create("div", "north-arrow"); };
    north.addTo(map);

    // Basemaps
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' });
    const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles ¬© Esri' });
    const esriTerrain = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles ¬© Esri' });
    const esriRoad = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles ¬© Esri' });
    osmLayer.addTo(map);

    /* === Territ√≥rios: cores e popup === */
    const territorioPalette = ['#1f78b4','#33a02c','#e31a1c','#ff7f00','#6a3d9a','#b15928','#a6cee3','#b2df8a','#fb9a99','#fdbf6f','#cab2d6','#ffff99'];
    const territorioColors = []; let colorIndex = 0;
    function getColorForTerritorio(nome, codigo = null) {
      let terr = territorioColors.find(t => t.nome === nome);
      if (!terr) {
        const display = codigo ? `TD ${codigo} ‚Äì ${nome}` : nome;
        terr = { nome, codigo, label: display, cor: territorioPalette[colorIndex % territorioPalette.length] };
        territorioColors.push(terr); colorIndex++;
      }
      return terr.cor;
    }

    function formatNumeroPTBR(n, d=2){return n.toLocaleString('pt-BR',{minimumFractionDigits:d,maximumFractionDigits:d});}
    function generateInfoContent(p){ 
      const labels = {
        NM_MUN:"Munic√≠pio:",CD_MUN:"C√≥digo do Munic√≠pio:",fid:"C√≥digo do Territ√≥rio:",
        NM_TD:"Territ√≥rio de Desenvolvimento:",AREA_KM2:"√Årea (km¬≤):",
        "Aglomerado - PI":"Aglomerado:",pib_porcent_Piaui:"PIB (%) Piau√≠:",pop_porcent_Piaui:"Popula√ß√£o (%) Piau√≠:",
        pib_porcent_TD:"PIB (%) TD:",pop_porcent_TD:"Popula√ß√£o (%) TD:",
        pib_2021:"PIB 2021:",pop_censo2022:"Popula√ß√£o (Censo 2022):",densidade_demografica:"Densidade demogr√°fica:"
      };
      const grupos = {
        geografico:["NM_MUN","CD_MUN","fid","NM_TD","Aglomerado - PI","AREA_KM2"],
        populacional:["pop_censo2022","densidade_demografica","pop_porcent_Piaui","pop_porcent_TD"],
        pib:["pib_2021","pib_porcent_Piaui","pib_porcent_TD"]
      };
      function formatValor(key,val){
        if(val===null||val===undefined) return "-";
        const num = Number(val);
        if(!isNaN(num)){
          if(["pib_porcent_Piaui","pop_porcent_Piaui","pib_porcent_TD","pop_porcent_TD"].includes(key)) return num.toFixed(2).replace('.',',')+"%";
          if(key==="CD_MUN") return String(Math.trunc(num));
          if(key==="pop_censo2022") return num.toLocaleString('pt-BR',{maximumFractionDigits:0});
          return formatNumeroPTBR(num,2);
        }
        return val;
      }
      function tabela(titulo,campos){
        let h = `<div style="text-align:center;font-weight:bold;font-size:1.05em;margin:10px 0;">${titulo}</div><table style="border-collapse:collapse;width:100%;font-size:.95em;">`;
        campos.forEach(k=>{
          if(k in p){
            h+=`<tr><th style="text-align:left;padding:6px 8px;border-bottom:1px solid #ddd;font-weight:normal;">${labels[k]||k}</th><td style="text-align:right;padding:6px 8px;border-bottom:1px solid #ddd;">${formatValor(k,p[k])}</td></tr>`;
          }
        });
        return h+="</table>";
      }
      return tabela("Informa√ß√µes Geogr√°ficas",grupos.geografico)+tabela("Informa√ß√µes Populacionais",grupos.populacional)+tabela("Informa√ß√µes de PIB",grupos.pib);
    }

    function onEachFeaturePopup(feature, layer) {
      if (!feature.properties) return;
      const popupContent = generateInfoContent(feature.properties)+`<button class="download-btn" style="margin-top:5px;">Baixar KML desta fei√ß√£o</button>`;
      layer.on('click', e => { map.panTo(e.latlng); layer.bindPopup(popupContent).openPopup(e.latlng); });
      layer.on('popupopen', () => {
        const btn = document.querySelector('.download-btn');
        if (btn) btn.onclick = () => {
          const kml = tokml({ type:"FeatureCollection", features:[feature] });
          const blob = new Blob([kml], { type: "application/vnd.google-earth.kml+xml" });
          const url = URL.createObjectURL(blob); const a = document.createElement("a");
          a.href = url; a.download = "feicao.kml"; a.click(); URL.revokeObjectURL(url);
        };
      });
    }

    function styleTerritorios(f){
      const nome = f.properties.NM_TD || "Territ√≥rio";
      const codigo = f.properties.fid || "";
      const cor = getColorForTerritorio(nome,codigo);
      return { color: cor, weight: 2, fillColor: cor, fillOpacity: 0.4 };
    }

    let territorioSelecionado = null;
    function highlightFeature(e){ e.target.setStyle({ weight:4, color:'#ff6600', fillColor:'#ff6600', fillOpacity:0.5 }); e.target.bringToFront(); }
    let municipioSelecionado = null;
    function resetHighlight(e){ if (municipioSelecionado !== e.target) municipiosLayer.resetStyle(e.target); }

    function highlightTerritory(nome) {
      territoriosLayer.eachLayer(layer => {
        if (!layer.feature) return;
        const nt = layer.feature.properties.NM_TD;
        const ct = layer.feature.properties.fid;
        if (nt === nome) {
          const cor = getColorForTerritorio(nt, ct);
          layer.setStyle({ color: cor, weight: 3, fillColor: cor, fillOpacity: 0.8 });
          map.fitBounds(layer.getBounds());
        } else {
          layer.setStyle({ color:"#222", weight:1, fillColor:"#222", fillOpacity:0.8 });
        }
      });
      municipiosLayer.eachLayer(mLayer => {
        mLayer.off("mouseover", highlightFeature);
        mLayer.off("mouseout", resetHighlight);
        mLayer.on({ mouseover: highlightFeature, mouseout: resetHighlight });
      });
      document.querySelectorAll('.territorio-item').forEach(item=>{
        item.style.fontWeight = (item.getAttribute('data-nome')===nome)?"bold":"normal";
        item.style.color = (item.getAttribute('data-nome')===nome)?"#000":"";
      });
    }

    function onEachMunicipio(feature, layer){
      const nome = feature.properties.NM_MUN || "Munic√≠pio desconhecido";
      layer.bindTooltip(`<b>${nome}</b><br><i>Clique para mais informa√ß√µes</i>`, { sticky:false, direction:'top', opacity:0.9 });
      layer.on("popupopen", ()=>layer.closeTooltip());
      layer.on({ mouseover: highlightFeature, mouseout: resetHighlight });
      layer.on("click", ()=>{
        if (municipioSelecionado && municipioSelecionado !== layer) municipiosLayer.resetStyle(municipioSelecionado);
        municipioSelecionado = layer;
        layer.setStyle({ weight:4, color:'#ff6600', fillColor:'#ff6600', fillOpacity:0.5 });
      });

      if (feature.properties) {
        layer.bindPopup(
          generateInfoContent(feature.properties)+
          `<button class="download-btn" style="margin-top:5px;">Baixar KML deste munic√≠pio</button>`
        );
        layer.on('popupopen', (e)=>{
          const popupEl = e.popup.getElement();
          const btn = popupEl.querySelector('.download-btn');
          if (btn) btn.addEventListener('click', ()=>{
            const nomeArquivo = (feature.properties?.NM_MUN || "municipio")
              .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
              .replace(/√ß/g,"c").replace(/√á/g,"C")
              .replace(/[^\w\s-]/g,"").replace(/\s+/g,"_");
            let kml = tokml({ type:"FeatureCollection", features:[feature] });
            const estiloKML = `
              <Style id="customStyle">
                <LineStyle><color>ff0000ff</color><width>2</width></LineStyle>
                <PolyStyle><color>00ff0000</color><fill>1</fill><outline>1</outline></PolyStyle>
              </Style>`;
            kml = kml.replace("</Document>", `${estiloKML}</Document>`).replace(/<Placemark>/g,'<Placemark><styleUrl>#customStyle</styleUrl>');
            const blob = new Blob([kml], { type:"application/vnd.google-earth.kml+xml" });
            const url = URL.createObjectURL(blob); const a = document.createElement("a");
            a.href = url; a.download = `${nomeArquivo}.kml`; a.click(); URL.revokeObjectURL(url);
          });
        });
      }
    }

    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && municipioSelecionado) {
        municipioSelecionado.closePopup();
        municipiosLayer.resetStyle(municipioSelecionado);
        municipioSelecionado = null;
      }
    });

    // Layers de dados
    const territoriosLayer = new L.GeoJSON.AJAX("territorios.geojson", { style: styleTerritorios, onEachFeature: onEachTerritorio });
    territoriosLayer.on('data:loaded', addLegend);
    territoriosLayer.addTo(map);
    

    // Fallback: se em 2s n√£o criou a legenda, for√ßa criar
    setTimeout(() => {
      if (!document.querySelector('.legend-toggle')) addLegend();
    }, 2000);

    function onEachTerritorio(feature, layer) {
      layer.on({
        mouseover: highlightFeature,
        mouseout: (e)=>territoriosLayer.resetStyle(e.target),
        click: function () {
          const territorioNome = feature.properties?.NM_TD;
          const territorioCodigo = feature.properties?.fid;
          const municipios = [];
          municipiosLayer.eachLayer(mLayer=>{
            const p = mLayer.feature?.properties || {};
            if ((p.NM_TD && territorioNome && p.NM_TD === territorioNome) ||
                (p.fid && territorioCodigo && p.fid === territorioCodigo)) {
              municipios.push(p.NM_MUN || "(sem nome)");
            }
          });
          municipios.sort((a,b)=>a.localeCompare(b,'pt-BR'));
          const baseHtml = `<b>Territ√≥rio:</b> ${territorioNome || "-"}<br><b>C√≥digo:</b> ${territorioCodigo || "-"}<br><button class="download-btn" style="margin-top:5px;">Baixar KML deste territ√≥rio</button>`;
          const listaHtml = municipios.length
            ? `<hr><b>Munic√≠pios (${municipios.length}):</b><div style="max-height:150px;overflow:auto;margin-top:6px;"><ul style="margin:0;padding-left:18px;">${municipios.map(n=>`<li>${n}</li>`).join('')}</ul></div>`
            : `<hr><i>Nenhum munic√≠pio associado encontrado.</i>`;
          layer.bindPopup(baseHtml + listaHtml);
          layer.on('popupopen', (e)=>{
            const popupEl = e.popup.getElement();
            const btn = popupEl.querySelector('.download-btn');
            if (btn) btn.addEventListener('click', ()=>{
              const nomeArquivo = (layer.feature.properties?.NM_TD || "territorio").replace(/[^\w\s-]/g,"").replace(/\s+/g,"_");
              let kml = tokml({ type:"FeatureCollection", features:[layer.feature] });
              const estiloKML = `
                <Style id="customStyle">
                  <LineStyle><color>ff00ffff</color><width>5</width></LineStyle>
                  <PolyStyle><color>00ffffff</color><fill>1</fill><outline>1</outline></PolyStyle>
                </Style>`;
              kml = kml.replace("</Document>", `${estiloKML}</Document>`).replace(/<Placemark>/g,'<Placemark><styleUrl>#customStyle</styleUrl>');
              const blob = new Blob([kml], { type:"application/vnd.google-earth.kml+xml" });
              const url = URL.createObjectURL(blob); const a = document.createElement("a");
              a.href = url; a.download = `${nomeArquivo}.kml`; a.click(); URL.revokeObjectURL(url);
            });
          });
          layer.openPopup();
        }
      });
    }

    const municipiosLayer = new L.GeoJSON.AJAX("municipios.geojson", { style: ()=>({ color:'#000', weight:1.5, fillOpacity:0 }), onEachFeature: onEachMunicipio });
    municipiosLayer.addTo(map);

    /* === Lit√≠gio === */
    function onEachLitigio(feature, layer){
      layer.on({ mouseover: highlightFeature, mouseout: e=>litigioLayer.resetStyle(e.target) });
      layer.bindPopup(`<b>Lit√≠gio</b><br><div style="margin-top:5px;"><button class="download-btn" data-format="kml">Baixar KML</button> <button class="download-btn" data-format="geojson">GeoJSON</button> <button class="download-btn" data-format="shp">Shapefile</button></div>`);
      layer.on("popupopen", ()=>{
        const btn = document.querySelector(".download-btn");
        if (btn) btn.onclick = ()=>{
          let kml = tokml({ type:"FeatureCollection", features:[feature] });
          const estiloKML = `
            <Style id="litigioStyle">
              <LineStyle><color>ff00ff00</color><width>3</width></LineStyle>
              <PolyStyle><color>00ffffff</color><fill>1</fill><outline>1</outline></PolyStyle>
            </Style>`;
          kml = kml.replace("</Document>", `${estiloKML}</Document>`).replace(/<Placemark>/g,'<Placemark><styleUrl>#litigioStyle</styleUrl>');
          const blob = new Blob([kml], { type:"application/vnd.google-earth.kml+xml" });
          const url = URL.createObjectURL(blob); const a = document.createElement("a");
          a.href = url; a.download = "litigio.kml"; a.click(); URL.revokeObjectURL(url);
        };
      });
    }
    const litigioLayer = new L.GeoJSON.AJAX("litigio.geojson", { style:{ color:'red', weight:2 }, onEachFeature: onEachLitigio }).addTo(map);

    /* === Linha Imperial === */
    function onEachImperial(feature, layer){
      layer.on({ mouseover: highlightFeature, mouseout: e=>linhaImperialLayer.resetStyle(e.target) });
      layer.bindPopup(`<b>Linha Imperial</b><br><button class="download-btn" style="margin-top:5px;">Baixar KML</button>`);
      layer.on("popupopen", ()=>{
        const btn = document.querySelector(".download-btn");
        if (btn) btn.onclick = ()=>{
          let kml = tokml({ type:"FeatureCollection", features:[feature] });
          const estiloKML = `
            <Style id="imperialStyle">
              <LineStyle><color>ff00a5ff</color><width>3</width></LineStyle>
              <PolyStyle><color>00ffffff</color><fill>1</fill><outline>1</outline></PolyStyle>
            </Style>`;
          kml = kml.replace("</Document>", `${estiloKML}</Document>`).replace(/<Placemark>/g,'<Placemark><styleUrl>#imperialStyle</styleUrl>');
          const blob = new Blob([kml], { type:"application/vnd.google-earth.kml+xml" });
          const url = URL.createObjectURL(blob); const a = document.createElement("a");
          a.href = url; a.download = "linha_imperial.kml"; a.click(); URL.revokeObjectURL(url);
        };
      });
    }
    const linhaImperialLayer = new L.GeoJSON.AJAX("linha_imperial.geojson", { style:{ color:'blue', weight:2, dashArray:'5,5' }, onEachFeature: onEachImperial }).addTo(map);
    litigioLayer.bringToFront();

    /* === Controle de camadas embrulhado === */
    const baseMaps = { "OpenStreetMap": osmLayer, "Esri Sat√©lite": esriSat, "Esri Terrain": esriTerrain, "Esri Road": esriRoad };
    const overlayMaps = { "Territ√≥rios": territoriosLayer, "Munic√≠pios": municipiosLayer, "Lit√≠gio": litigioLayer, "Linha Imperial": linhaImperialLayer };
    const layersControl = L.control.layers(baseMaps, overlayMaps, { collapsed:false, position:'topleft' }).addTo(map);

    map.whenReady(()=>{
      const panel = document.querySelector('.leaflet-control-layers');
      if (panel) {
        panel.classList.add('collapsed-panel');
        const wrapper = document.createElement('div');
        wrapper.id = 'camadasWrapper';
        const header = document.createElement('div');
        header.id = 'camadasHeader';
        header.innerText = 'Visualizar Camadas';
        header.addEventListener('click', ()=> panel.classList.toggle('collapsed-panel'));
        wrapper.appendChild(header);
        wrapper.appendChild(panel);
        document.body.appendChild(wrapper);
      }
    });

    /* === Legenda (montada diretamente no body; robusto) === */
    function addLegend() {
      // Se necess√°rio, popula cores a partir das features carregadas
      if (!territorioColors.length && territoriosLayer) {
        territoriosLayer.eachLayer(l => {
          const p = l.feature?.properties || {};
          getColorForTerritorio(p.NM_TD || 'Territ√≥rio', p.fid || '');
        });
      }

      // Remove inst√¢ncias anteriores
      document.querySelectorAll('.legend, .legend-toggle').forEach(el => el.remove());

      // Bot√£o e caixa
      const toggleBtn = document.createElement('button');
      toggleBtn.className = 'legend-toggle attention';
      toggleBtn.textContent = 'Selecionar  territ√≥rios';

      const legendDiv = document.createElement('div');
      legendDiv.className = 'legend collapsed';
      legendDiv.innerHTML = '<div style="text-align:center;font-weight:bold;margin-bottom:5px;">Territ√≥rios de Desenvolvimento</div>';

      territorioColors.slice().sort((a,b)=>(a.codigo||0)-(b.codigo||0)).forEach(t => {
        const item = document.createElement('div');
        item.className = 'territorio-item';
        item.dataset.nome = t.nome;
        item.style.cssText = 'cursor:pointer;display:flex;align-items:center;gap:6px;margin-bottom:6px;';
        item.innerHTML = `<i style="background:${t.cor};width:24px;height:24px;display:inline-block;"></i>
                          <span style="font-size:13px;">${t.label}</span>`;
        item.addEventListener('click', () => highlightTerritory(t.nome));
        legendDiv.appendChild(item);
      });

      legendDiv.insertAdjacentHTML('beforeend',
        '<hr style="margin:5px 0;"><small>Coordena√ß√£o de Cartografia e An√°lise Espacial<br>CCAE/CIET/SEPLAN</small>'
      );

      toggleBtn.addEventListener('click', () => {
        legendDiv.classList.toggle('collapsed');
        toggleBtn.textContent = legendDiv.classList.contains('collapsed')
          ? 'Selecionar  territ√≥rios'
          : 'Ocultar territ√≥rios';
        toggleBtn.classList.remove('attention');
      });

      document.body.appendChild(toggleBtn);
      document.body.appendChild(legendDiv);
    }

    /* Lat/Lon -> UTM + coordenadas no rodap√© */
    function latLonToUTM(lat, lon) {
      const a=6378137,f=1/298.257223563,k0=0.9996,e=Math.sqrt(f*(2-f));
      const zone=Math.floor((lon+180)/6)+1, l0=(zone-1)*6-180+3, l0r=l0*Math.PI/180;
      const p=lat*Math.PI/180, l=lon*Math.PI/180;
      const N=a/Math.sqrt(1-e*e*Math.sin(p)*Math.sin(p)), T=Math.tan(p)*Math.tan(p), C=(e*e/(1-e*e))*Math.cos(p)*Math.cos(p), A=Math.cos(p)*(l-l0r);
      const M=a*((1-e*e/4-3*e**4/64-5*e**6/256)*p-(3*e*e/8+3*e**4/32+45*e**6/1024)*Math.sin(2*p)+(15*e**4/256+45*e**6/1024)*Math.sin(4*p)-(35*e**6/3072)*Math.sin(6*p));
      const x=k0*N*(A+(1-T+C)*A**3/6+(5-18*T+T*T+72*C-58*(e*e/(1-e*e)))*A**5/120)+500000;
      let y=k0*(M+N*Math.tan(p)*(A**2/2+(5-T+9*C+4*C**2)*A**4/24+(61-58*T+T*T+600*C-330*(e*e/(1-e*e)))*A**6/720));
      if(lat<0) y+=10000000;
      return { x, y, zone };
    }
    const coordsDiv = document.getElementById('coords');
    map.on('mousemove', e=>{
      const lat=e.latlng.lat.toFixed(5), lon=e.latlng.lng.toFixed(5);
      const utm=latLonToUTM(e.latlng.lat,e.latlng.lng);
      coordsDiv.innerHTML = `Lat: ${lat}, Lon: ${lon}<br>E: ${utm.x.toFixed(2)}, N: ${utm.y.toFixed(2)}<br>Fuso: ${utm.zone}`;
    });

    /* Upload KML/KMZ */
    const uploadBtnEl=document.getElementById('uploadBtn');
    const uploadInputEl=document.getElementById('uploadInput');
    uploadBtnEl.addEventListener('click', ()=>uploadInputEl.click());
    uploadInputEl.addEventListener('change', async (e)=>{
      const files=[...e.target.files];
      for (const file of files){
        const name=file.name;
        try{
          if(name.toLowerCase().endsWith('.kml')){
            const text=await file.text(); addKMLTextToMap(text,name);
          } else if(name.toLowerCase().endsWith('.kmz')){
            const arrayBuf=await file.arrayBuffer(); const zip=await JSZip.loadAsync(arrayBuf);
            let kmlEntry=null; zip.forEach((relPath,zipEntry)=>{ if(!kmlEntry && relPath.toLowerCase().endsWith('.kml')) kmlEntry=zipEntry; });
            if(!kmlEntry){ alert('KMZ sem arquivo KML interno: '+name); continue; }
            const kmlText=await kmlEntry.async('text'); addKMLTextToMap(kmlText,name);
          } else { alert('Formato n√£o suportado: '+name); }
        } catch(err){ console.error(err); alert('Erro ao carregar '+name+': '+err.message); }
      }
      uploadInputEl.value='';
    });
    function addKMLTextToMap(kmlText, layerName){
      const kmlLayer=omnivore.kml.parse(kmlText).addTo(map);
      if (layersControl) layersControl.addOverlay(kmlLayer, layerName);
      try { map.fitBounds(kmlLayer.getBounds()); } catch(_) {}
    }

    /* Rosa dos Ventos (fixa) */
    const rosaSBG = L.control({ position: "bottomleft" });
    rosaSBG.onAdd = function () {
      const div = L.DomUtil.create("div", "rosa-sbg");
      div.innerHTML = `
        <svg width="140" height="140" viewBox="0 0 140 140" xmlns="http://www.w3.org/2000/svg">
          <polygon points="70,40 90,80 50,80" fill="black" />
          <text x="70" y="30" font-size="36" font-weight="bold" fill="black" stroke="black" stroke-width="1" text-anchor="middle" dominant-baseline="middle">N</text>
        </svg>`;
      return div;
    };
    rosaSBG.addTo(map);

    /* Estado do Piau√≠ + Biomas recortados */
    fetch("piaui.geojson").then(r=>r.json()).then(piauiData=>{
      const piauiLayer = L.geoJSON(piauiData,{ style:{ color:'yellow', weight:3, fillColor:'transparent', fillOpacity:0 }, onEachFeature:(f,l)=>l.bindPopup("Estado do Piau√≠") }).addTo(map);
      piauiLayer.bringToBack();
      layersControl.addOverlay(piauiLayer,"Estado do Piau√≠");

      const worldBounds = turf.bboxPolygon([-90,-60,-25,15]);
      const mask = turf.difference(worldBounds, piauiData.features[0]);
      L.geoJSON(mask,{ style:{ fillColor:'black', fillOpacity:0.5, color:'black', weight:0 }, interactive:false }).addTo(map);

      function styleBiomas(feature){
        const bioma=(feature.properties.Bioma||feature.properties.bioma||"").toLowerCase();
        switch(bioma){
          case "amaz√¥nia": case "amazonia": return { color:"#1B5E20", fillColor:"#1B5E20", fillOpacity:0.5, weight:1 };
          case "caatinga": return { color:"#E6B800", fillColor:"#E6B800", fillOpacity:0.5, weight:1 };
          case "cerrado": return { color:"#4CAF50", fillColor:"#4CAF50", fillOpacity:0.5, weight:1 };
          case "mata atl√¢ntica": case "mata atlantica": return { color:"#00695C", fillColor:"#00695C", fillOpacity:0.5, weight:1 };
          case "pantanal": return { color:"#8D6E63", fillColor:"#8D6E63", fillOpacity:0.5, weight:1 };
          case "pampa": return { color:"#A1887F", fillColor:"#A1887F", fillOpacity:0.5, weight:1 };
          default: return { color:"#9E9E9E", fillColor:"#9E9E9E", fillOpacity:0.5, weight:1 };
        }
      }

      fetch("biomas.geojson").then(r=>r.json()).then(biomasData=>{
        const biomasRecortados={ type:"FeatureCollection", features:[] };
        biomasData.features.forEach(f=>{
          try{
            const inter=turf.intersect(f, piauiData.features[0]);
            if(inter){ inter.properties=f.properties; biomasRecortados.features.push(inter); }
          }catch(e){ console.warn("Erro ao recortar bioma:", e); }
        });
        const biomasLayer=L.geoJSON(biomasRecortados,{
          style: styleBiomas,
          onEachFeature: (feature, layer)=>layer.bindPopup(`<b>Bioma:</b> ${feature.properties.Bioma||feature.properties.bioma||"Bioma"}`)
        }).addTo(map);
        biomasLayer.bringToBack();
        layersControl.addOverlay(biomasLayer, "Biomas");
      });
    });

    /* ESC limpa sele√ß√£o e recolhe busca */
    document.addEventListener('keydown', e=>{
      if (e.key==="Escape") {
        territorioSelecionado=null;
        territoriosLayer.eachLayer(layer=>territoriosLayer.resetStyle(layer));
        const sc = document.getElementById('searchContainer');
        const si = document.getElementById('searchMunicipio');
        const lm = document.getElementById('listaMunicipios');
        if (sc.classList.contains('expanded')) {
          sc.classList.remove('expanded');
          si.value = '';
          lm.style.display='none';
        }
      }
    });

    // Ajuste de bounds inicial
    setTimeout(()=>{
      const group=new L.featureGroup([territoriosLayer, municipiosLayer]);
      try { map.fitBounds(group.getBounds(), { padding:[20,20] }); } catch(_) {}
    }, 800);

    // Resize handler garante 100% do viewport
    function ajustarMapa(){ document.getElementById('map').style.height=window.innerHeight+'px'; }
    window.addEventListener('resize', ajustarMapa);
    window.addEventListener('orientationchange', ajustarMapa);
    ajustarMapa();

    // Controle da barra de pesquisa expans√≠vel + clique fora
    (()=>{
      const sc = document.getElementById('searchContainer');
      const st = document.getElementById('searchToggle');
      const si = document.getElementById('searchMunicipio');
      const lm = document.getElementById('listaMunicipios');
      st.addEventListener('click', ()=>{
        sc.classList.toggle('expanded');
        if (sc.classList.contains('expanded')) si.focus();
        else { si.value=''; lm.style.display='none'; }
      });
      document.addEventListener('click', (e)=>{
        if (!sc.contains(e.target) && sc.classList.contains('expanded')) {
          sc.classList.remove('expanded');
          si.value=''; lm.style.display='none';
        }
      });
    })();

    /* Busca Fuzzy */
    let highlightedIndex=-1;
    function levenshtein(a,b){const m=[];for(let i=0;i<=b.length;i++){m[i]=[i]}for(let j=0;j<=a.length;j++){m[0][j]=j}for(let i=1;i<=b.length;i++){for(let j=1;j<=a.length;j++){m[i][j]=(b.charAt(i-1)===a.charAt(j-1))?m[i-1][j-1]:Math.min(m[i-1][j-1]+1,Math.min(m[i][j-1]+1,m[i-1][j]+1))}}return m[b.length][a.length]}
    function updateHighlight(itens){itens.forEach((item,idx)=>{ if(idx===highlightedIndex){item.classList.add('highlighted'); item.scrollIntoView({block:'nearest'});} else item.classList.remove('highlighted'); });}

    const si = document.getElementById('searchMunicipio');
    const lm = document.getElementById('listaMunicipios');
    si.addEventListener('input', function(){
      const termo=this.value.trim().toLowerCase();
      lm.innerHTML=''; highlightedIndex=-1;
      if(!termo){ lm.style.display='none'; return; }
      const resultados=[];
      municipiosLayer.eachLayer(layer=>{
        const nomeMun=layer.feature?.properties?.NM_MUN;
        if(!nomeMun) return;
        const nomeLower=nomeMun.toLowerCase();
        if (nomeLower.includes(termo)) resultados.push({nome:nomeMun, layer});
        else if (levenshtein(termo, nomeLower) <= 3) resultados.push({nome:nomeMun, layer});
      });
      if(!resultados.length){ lm.style.display='none'; return; }
      resultados.sort((a,b)=>a.nome.localeCompare(b.nome,'pt-BR'));
      resultados.forEach(item=>{
        const div=document.createElement('div'); div.textContent=item.nome;
        div.addEventListener('click', ()=>{
          map.fitBounds(item.layer.getBounds()); item.layer.openPopup();
          if (municipioSelecionado) municipiosLayer.resetStyle(municipioSelecionado);
          item.layer.setStyle({ weight:4, color:'#ff6600', fillColor:'#ff6600', fillOpacity:0.5 });
          municipioSelecionado=item.layer;
          lm.style.display='none'; si.value=item.nome;
        });
        lm.appendChild(div);
      });
      lm.style.display='block';
    });

    si.addEventListener('keydown', (e)=>{
      const itens=lm.querySelectorAll('div');
      if (e.key==='ArrowDown'){ e.preventDefault(); if(highlightedIndex < itens.length-1){ highlightedIndex++; updateHighlight(itens);} }
      else if (e.key==='ArrowUp'){ e.preventDefault(); if(highlightedIndex>0){ highlightedIndex--; updateHighlight(itens);} }
      else if (e.key==='Enter'){ e.preventDefault(); if(highlightedIndex>=0 && highlightedIndex<itens.length){ itens[highlightedIndex].click(); } }
    });
  </script>
</body>
</html>
